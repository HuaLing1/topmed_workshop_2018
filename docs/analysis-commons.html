<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>TOPMed Analysis Workshop</title>
  <meta name="description" content="Course materials for the TOPMed analysis workshop">
  <meta name="generator" content="bookdown 0.4 and GitBook 2.6.7">

  <meta property="og:title" content="TOPMed Analysis Workshop" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Course materials for the TOPMed analysis workshop" />
  <meta name="github-repo" content="UW-GAC/topmed_workshop_2017" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="TOPMed Analysis Workshop" />
  
  <meta name="twitter:description" content="Course materials for the TOPMed analysis workshop" />
  



<meta name="date" content="2017-08-01">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="analysis-pipeline.html">

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="downloading-data-from-the-topmed-exchange-area.html"><a href="downloading-data-from-the-topmed-exchange-area.html"><i class="fa fa-check"></i><b>2</b> Downloading Data From The TOPMed Exchange Area</a></li>
<li class="chapter" data-level="3" data-path="gds-format.html"><a href="gds-format.html"><i class="fa fa-check"></i><b>3</b> GDS format</a><ul>
<li class="chapter" data-level="3.1" data-path="gds-format.html"><a href="gds-format.html#exploring-a-gds-file"><i class="fa fa-check"></i><b>3.1</b> Exploring a GDS file</a></li>
<li class="chapter" data-level="3.2" data-path="gds-format.html"><a href="gds-format.html#exercise-hwe"><i class="fa fa-check"></i><b>3.2</b> Exercise: HWE</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="computing-a-grm.html"><a href="computing-a-grm.html"><i class="fa fa-check"></i><b>4</b> Computing a GRM</a></li>
<li class="chapter" data-level="5" data-path="pc-relate.html"><a href="pc-relate.html"><i class="fa fa-check"></i><b>5</b> PC-Relate</a><ul>
<li class="chapter" data-level="5.1" data-path="pc-relate.html"><a href="pc-relate.html#king"><i class="fa fa-check"></i><b>5.1</b> KING</a></li>
<li class="chapter" data-level="5.2" data-path="pc-relate.html"><a href="pc-relate.html#pc-air"><i class="fa fa-check"></i><b>5.2</b> PC-AiR</a></li>
<li class="chapter" data-level="5.3" data-path="pc-relate.html"><a href="pc-relate.html#pc-relate-1"><i class="fa fa-check"></i><b>5.3</b> PC-Relate</a></li>
<li class="chapter" data-level="5.4" data-path="pc-relate.html"><a href="pc-relate.html#exercise"><i class="fa fa-check"></i><b>5.4</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="finding-topmed-study-phenotypes-on-dbgap.html"><a href="finding-topmed-study-phenotypes-on-dbgap.html"><i class="fa fa-check"></i><b>6</b> Finding TOPMed Study Phenotypes on dbGaP</a></li>
<li class="chapter" data-level="7" data-path="association-tests.html"><a href="association-tests.html"><i class="fa fa-check"></i><b>7</b> Association tests</a><ul>
<li class="chapter" data-level="7.1" data-path="association-tests.html"><a href="association-tests.html#null-model"><i class="fa fa-check"></i><b>7.1</b> Null model</a></li>
<li class="chapter" data-level="7.2" data-path="association-tests.html"><a href="association-tests.html#single-variant-tests"><i class="fa fa-check"></i><b>7.2</b> Single-variant tests</a></li>
<li class="chapter" data-level="7.3" data-path="association-tests.html"><a href="association-tests.html#sliding-window-tests"><i class="fa fa-check"></i><b>7.3</b> Sliding window tests</a></li>
<li class="chapter" data-level="7.4" data-path="association-tests.html"><a href="association-tests.html#exercise-logistic-regression"><i class="fa fa-check"></i><b>7.4</b> Exercise: logistic regression</a></li>
<li class="chapter" data-level="7.5" data-path="association-tests.html"><a href="association-tests.html#aggregate-tests"><i class="fa fa-check"></i><b>7.5</b> Aggregate tests</a><ul>
<li class="chapter" data-level="7.5.1" data-path="association-tests.html"><a href="association-tests.html#variant-annotation"><i class="fa fa-check"></i><b>7.5.1</b> Variant annotation</a></li>
<li class="chapter" data-level="7.5.2" data-path="association-tests.html"><a href="association-tests.html#defining-aggregate-units"><i class="fa fa-check"></i><b>7.5.2</b> Defining aggregate units</a></li>
<li class="chapter" data-level="7.5.3" data-path="association-tests.html"><a href="association-tests.html#association-testing-with-aggregate-units"><i class="fa fa-check"></i><b>7.5.3</b> Association testing with aggregate units</a></li>
<li class="chapter" data-level="7.5.4" data-path="association-tests.html"><a href="association-tests.html#exercise-1"><i class="fa fa-check"></i><b>7.5.4</b> Exercise</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="analysis-pipeline.html"><a href="analysis-pipeline.html"><i class="fa fa-check"></i><b>8</b> Analysis Pipeline</a><ul>
<li class="chapter" data-level="8.1" data-path="analysis-pipeline.html"><a href="analysis-pipeline.html#running-on-a-local-cluster"><i class="fa fa-check"></i><b>8.1</b> Running on a local cluster</a></li>
<li class="chapter" data-level="8.2" data-path="analysis-pipeline.html"><a href="analysis-pipeline.html#running-on-aws-batch"><i class="fa fa-check"></i><b>8.2</b> Running on AWS Batch</a><ul>
<li class="chapter" data-level="8.2.1" data-path="analysis-pipeline.html"><a href="analysis-pipeline.html#log-into-aws-docker-image"><i class="fa fa-check"></i><b>8.2.1</b> Log into AWS docker image</a></li>
<li class="chapter" data-level="8.2.2" data-path="analysis-pipeline.html"><a href="analysis-pipeline.html#cd-to-working-directory-and-create-config-file"><i class="fa fa-check"></i><b>8.2.2</b> cd to working directory and create config file</a></li>
<li class="chapter" data-level="8.2.3" data-path="analysis-pipeline.html"><a href="analysis-pipeline.html#print-out-aws-commands-if-executing-the-pipeline"><i class="fa fa-check"></i><b>8.2.3</b> Print out AWS commands if executing the pipeline</a></li>
<li class="chapter" data-level="8.2.4" data-path="analysis-pipeline.html"><a href="analysis-pipeline.html#execute-the-pipeline"><i class="fa fa-check"></i><b>8.2.4</b> Execute the pipeline</a></li>
<li class="chapter" data-level="8.2.5" data-path="analysis-pipeline.html"><a href="analysis-pipeline.html#monitor-the-jobs"><i class="fa fa-check"></i><b>8.2.5</b> Monitor the jobs</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="analysis-commons.html"><a href="analysis-commons.html"><i class="fa fa-check"></i><b>9</b> Analysis Commons</a><ul>
<li class="chapter" data-level="9.1" data-path="analysis-commons.html"><a href="analysis-commons.html#outline"><i class="fa fa-check"></i><b>9.1</b> Outline</a></li>
<li class="chapter" data-level="9.2" data-path="analysis-commons.html"><a href="analysis-commons.html#web-interface-and-running-an-analysis-application"><i class="fa fa-check"></i><b>9.2</b> Web Interface and Running an Analysis Application</a><ul>
<li class="chapter" data-level="9.2.1" data-path="analysis-commons.html"><a href="analysis-commons.html#exercise-1-run-a-single-variant-analysis."><i class="fa fa-check"></i><b>9.2.1</b> Exercise 1) Run a single variant analysis.</a></li>
<li class="chapter" data-level="9.2.2" data-path="analysis-commons.html"><a href="analysis-commons.html#exercise-2-run-skat-test-grouping-variants-into-gene-transcript-regions-and-limit-the-variants-to-those-with-a-cadd-phred-score-2-and-maf-5."><i class="fa fa-check"></i><b>9.2.2</b> Exercise 2) Run SKAT test grouping variants into gene transcript regions and limit the variants to those with a CADD phred score &gt; 2 and MAF &lt;= 5%.</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="analysis-commons.html"><a href="analysis-commons.html#command-line-interface"><i class="fa fa-check"></i><b>9.3</b> Command line interface</a><ul>
<li class="chapter" data-level="9.3.1" data-path="analysis-commons.html"><a href="analysis-commons.html#log-in-to-awi"><i class="fa fa-check"></i><b>9.3.1</b> Log in to AWI</a></li>
<li class="chapter" data-level="9.3.2" data-path="analysis-commons.html"><a href="analysis-commons.html#exercise-3-navigate-directories-make-output-directory-examine-files"><i class="fa fa-check"></i><b>9.3.2</b> Exercise 3) Navigate directories, make output directory, examine files</a></li>
<li class="chapter" data-level="9.3.3" data-path="analysis-commons.html"><a href="analysis-commons.html#exercise-4-run-single-variant-analysis-from-command-line-using-bash-script"><i class="fa fa-check"></i><b>9.3.3</b> Exercise 4) Run single variant analysis from command line using bash script</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="analysis-commons.html"><a href="analysis-commons.html#writing-your-own-apps"><i class="fa fa-check"></i><b>9.4</b> Writing your own Apps</a><ul>
<li class="chapter" data-level="9.4.1" data-path="analysis-commons.html"><a href="analysis-commons.html#exercise-5-write-an-app-that-creates-phenotype-residuals-and-performs-an-inverse-normal-transform"><i class="fa fa-check"></i><b>9.4.1</b> Exercise 5) Write an App that creates phenotype residuals and performs an inverse normal transform</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">TOPMed Analysis Workshop</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="analysis-commons" class="section level1">
<h1><span class="header-section-number">9</span> Analysis Commons</h1>
<div id="outline" class="section level2">
<h2><span class="header-section-number">9.1</span> Outline</h2>
<ul>
<li>Introduction to web-interface</li>
<li>Running a single variant analysis</li>
<li>Workflows and monitoring jobs</li>
<li>Running aggregate tests (SKAT)</li>
<li>Run batch jobs from the command line</li>
<li>Writing your own Apps</li>
</ul>
</div>
<div id="web-interface-and-running-an-analysis-application" class="section level2">
<h2><span class="header-section-number">9.2</span> Web Interface and Running an Analysis Application</h2>
<div id="exercise-1-run-a-single-variant-analysis." class="section level3">
<h3><span class="header-section-number">9.2.1</span> Exercise 1) Run a single variant analysis.</h3>
<p>Note that the job will finish instantaneously if you don’t change the output file name. It knows that you are running the exact same job and will just reuse results from previous analyses.</p>
<p>Log into <a href="http://dnanexus.com" class="uri">http://dnanexus.com</a> using the user name and password listed on the handout.<br />
Should be in the form of Username:<strong>topmed_#</strong> and Password:<strong>Topmed_#</strong>. <em>Ignore warning about default billing account.</em> Navigate to and select <strong>(dcc:tools/genesis_v0.7)</strong></p>
<p>File inputs:<br />
* phenofile -&gt; phenotype/1KG_pheno.csv<br />
* genotypefile -&gt; genotypes/1KG_phase3_subset_chr1.gds<br />
* kinship -&gt; kinship/1KG_kins.Rda<br />
* Note: orange aggregation, annotation and genefile can be left empty</p>
<p>Parameter inputs:<br />
* output folder: output/YOURFOLDERNAME<br />
* outcome <em>(Column name of the outcome variable)</em>: outcome<br />
* covariates <em>(case sepecific)</em>: Population,sex<br />
* prefix for output filename: single_chr1<br />
* test_type: Single<br />
* ID: sample.id<br />
* Note: Other options can be left as their defaults, some are only used for aggreagate tests</p>
</div>
<div id="exercise-2-run-skat-test-grouping-variants-into-gene-transcript-regions-and-limit-the-variants-to-those-with-a-cadd-phred-score-2-and-maf-5." class="section level3">
<h3><span class="header-section-number">9.2.2</span> Exercise 2) Run SKAT test grouping variants into gene transcript regions and limit the variants to those with a CADD phred score &gt; 2 and MAF &lt;= 5%.</h3>
<p><em>Italic</em> inputs below are the same as single variant; update the parameters &amp; files to change to a SKAT test. Go to the monitor tab. Click on the Name of a job ( or someone’s ) that successfully completed the single variant analysis, then click “Launch as new Job” and modify the inputs.</p>
<p>File inputs:<br />
* <em>phenofile -&gt; phenotype/1KG_pheno.csv</em><br />
* <em>genotypefile -&gt; genotypes/1KG_phase3_subset_chr1.gds</em><br />
* <em>kinship -&gt; kinship/1KG_kins.Rda</em><br />
* annotation -&gt; annotation/1KG_annotation_CHR1.txt<br />
* genefile -&gt; aggregation/AggUnit_CHR1_ucscgene.csv</p>
<p>Parameter inputs:<br />
* <em>outcome: outcome</em><br />
* <em>covariates: Population,sex</em><br />
* <em>ID: sample.id</em><br />
* output folder: output/YOURFOLDERNAME<br />
* outputfilename: skat_chr1_geneBased_CADDgt2<br />
* test_type: SKAT<br />
* snp_filter: CADD_phred&gt;2<br />
* min_mac:0<br />
* top_maf: 0.05<br />
* weights: c(1,25)</p>
</div>
</div>
<div id="command-line-interface" class="section level2">
<h2><span class="header-section-number">9.3</span> Command line interface</h2>
<p>References:<br />
* Command Line Interface <a href="https://wiki.dnanexus.com/Command-Line-Client/Quickstart">Quickstart</a><br />
* Index of <a href="https://wiki.dnanexus.com/Command-Line-Client/Index%20of%20dx%20Commands">dx commands</a></p>
<div id="log-in-to-awi" class="section level3">
<h3><span class="header-section-number">9.3.1</span> Log in to AWI</h3>
<p><strong>Replace topmed# with the user ID from your handout</strong></p>
<pre><code>$ ssh -i ~/.ssh/tm_workshop.pem topmed_#@34.209.245.0
$ source /usr/local/dx-toolkit/environment</code></pre>
<pre><code>$ dx login 
    Enter the following at the prompts
        username: topmed_#
        password: Topmed_#
        project:dcc

$ dx select dcc</code></pre>
</div>
<div id="exercise-3-navigate-directories-make-output-directory-examine-files" class="section level3">
<h3><span class="header-section-number">9.3.2</span> Exercise 3) Navigate directories, make output directory, examine files</h3>
<ul>
<li>File paths: &lt;project&gt;:/path/to/file.txt</li>
<li>Example: dcc:/phenotypes/1KG_pheno.csv</li>
</ul>
<p>List directory contents:</p>
<pre><code>$ dx select dcc
$ dx ls
$ dx ls /tools
$ dx ls dcc:/tools</code></pre>
<p>Get results from project</p>
<pre><code>$ dx download dcc:/phenotype/1KG_pheno.csv</code></pre>
</div>
<div id="exercise-4-run-single-variant-analysis-from-command-line-using-bash-script" class="section level3">
<h3><span class="header-section-number">9.3.3</span> Exercise 4) Run single variant analysis from command line using bash script</h3>
<p>Open the Single.sh bash script and edit to replace the output directory “YOURNAME” to your folder</p>
<pre><code>$ dx describe tools/genesis_v0.7</code></pre>
<p>Either edit using vi</p>
<pre><code>$ vi Single_multichrom.sh </code></pre>
<p>Or if not a vi fan you can use this line to substitute your name for the directory name. Please replace ‘JenB’ with your output directory name in the line below.</p>
<pre><code>$ sed -i &#39;s/YOURNAME/JenB/&#39; Single_multichrom.sh</code></pre>
</div>
</div>
<div id="writing-your-own-apps" class="section level2">
<h2><span class="header-section-number">9.4</span> Writing your own Apps</h2>
<div id="exercise-5-write-an-app-that-creates-phenotype-residuals-and-performs-an-inverse-normal-transform" class="section level3">
<h3><span class="header-section-number">9.4.1</span> Exercise 5) Write an App that creates phenotype residuals and performs an inverse normal transform</h3>
<p>Use app wizard to create template</p>
<pre><code>$ dx-app-wizard

App Name: make_residuals
Title []: Create inverse normal transformed residuals

1st input name (&lt;ENTER&gt; to finish): phenofile
Label (optional human-readable name) []: CSV phenotype file
Choose a class (&lt;TAB&gt; twice for choices): file
This is an optional parameter [y/n]: n

2nd input name (&lt;ENTER&gt; to finish): model
Label (optional human-readable name) []: model for creating residuals (e.g. outcome~age+Population )
Choose a class (&lt;TAB&gt; twice for choices): string
This is an optional parameter [y/n]: n

3rd input name (&lt;ENTER&gt; to finish): prefix
Label (optional human-readable name) []: Output filename prefix
Choose a class (&lt;TAB&gt; twice for choices): string
This is an optional parameter [y/n]: n

4th input name (&lt;ENTER&gt; to finish): &lt;ENTER&gt;

1st output name (&lt;ENTER&gt; to finish): output
Label (optional human-readable name) []: 
Choose a class (&lt;TAB&gt; twice for choices): file

Timeout policy [48h]: 1h
Programming language: bash

*Use defaults for other options*</code></pre>
<p>Look at the files created by the wizard</p>
<pre><code>cd make_residuals/
ls
more dxapp.json </code></pre>
<p>Edit App executable to run an R script</p>
<pre><code>$ vi src/make_residuals.sh
main() {

    echo &quot;Value of phenofile: &#39;$phenofile&#39;&quot;
    echo &quot;Value of model: &#39;$model&#39;&quot;
    echo &quot;Value of prefix: &#39;$prefix&#39;&quot;

    dx download &quot;$phenofile&quot; -o phenofile

    Rscript /make_resid.R $model

    output=$(dx upload output --brief)

    dx-jobutil-add-output output &quot;$output&quot; --class=file
    dx mv ${output} ${prefix}.csv
}
</code></pre>
<p>Create an R script that does the ‘work’ <code>$ vi resources/make_resid.R</code></p>
<pre><code>args&lt;-commandArgs(TRUE)
model &lt;- as.formula(args[1])
print(model)
pheno = read.csv(&quot;phenofile&quot;,as.is=T)
pheno$resid = residuals(lm(model,data=pheno))
pheno$invnt_resid =  with(pheno,qnorm((rank(resid,na.last=&quot;keep&quot;)-0.5)/sum(!is.na(resid))))

write.csv(pheno,file=&quot;output&quot;,row.names=F)</code></pre>
<p>Build the App</p>
<pre><code>$ dx build -f make_residuals --destination=output/YOURNAME/make_residuals</code></pre>
<p>Run the App</p>
<pre><code>$ dx run output/YOURNAME/make_residuals -iphenofile=phenotype/1KG_pheno.csv \
-imodel=outcome~sex+Population -iprefix=1kg_pheno_invnt \
--destination=output/YOURNAME --yes</code></pre>
<p>Monitor Progress</p>
<pre><code>$ dx watch jobid</code></pre>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="analysis-pipeline.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
